name: feature-nodejs-pipeline
on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
      component:
        required: true
        type: string
      environment:
        required: true
        type: string
    secrets:
      DEPENDABOT_PAT:
        required: true
env:
  ACCOUNT_ID: 522534289017

jobs:
  feature-nodejs-pipeline:
    runs-on: self-hosted
    steps: 
# ---------------- CHECKOUT ----------------
    - name: checkout code
      uses: actions/checkout@v6

    - name: list files
      run: ls -l

    - name: Get the version from commit id
      run: |
        echo "APP_VERSION=${GITHUB_SHA::9}" >> $GITHUB_ENV

    - name: Print Inputs
      run: |
        echo ${{ inputs.project }}
        echo "App Version is: ${APP_VERSION}"

    - name: Install Dependencies
      run: npm install

# ---------------- UNIT TEST ----------------
    - name: Run Unit Tests
      id: unit_tests
      run: echo "Unit test completed"

    - name: Update UNIT_TEST status
      if: always()
      uses: azhardevmd/workflows/.github/actions/set-commit-status@main
      with:
        state: ${{ steps.unit_tests.outcome }}
        context: UNIT_TEST
        status_description: "Unit Test ${{ steps.unit_tests.outcome }}"
        target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

# ---------------- SECURITY GATE ----------------
    - name: Security Check (Dependabot + Trivy)
      id: security_check
      # env:
      #   GH_TOKEN: ${{ secrets.GH_TOKEN }}
      shell: bash
      run: |

        echo "ðŸ” Running Trivy scan..."
        trivy image \
          --scanners vuln \
          --severity HIGH,CRITICAL,MEDIUM \
          --pkg-types os \
          --exit-code 1 \
          --format table \
          ${ACC_ID}.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${APP_VERSION}

        TRIVY_RESULT=$?

        if [ "$TRIVY_RESULT" -ne 0 ]; then
          echo "âŒ Trivy found vulnerabilities (HIGH/CRITICAL/MEDIUM)"
          exit 1
        fi

        echo "âœ… Trivy scan passed without blocking issues."

    - name: Update Security_Check status
      if: always()
      uses: azhardevmd/workflows/.github/actions/set-commit-status@main
      with:
        state: ${{ steps.security_check.outcome }}
        context: security_check
        status_description: "Dependency Review ${{ steps.security_check.outcome }}"
        target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    # - name: Install jq (RHEL)
    #   run: |
    #     sudo yum install -y jq || sudo dnf install -y jq

    # - name: Dependabot Security Gate
    #   id: dependabot_scan
    #   env:
    #     GH_TOKEN: ${{ secrets.DEPENDABOT_PAT }}
    #     REPO: ${{ github.repository }}
    #   run: |
    #     echo "Checking Dependabot alerts for $REPO"

    #     ALERTS=$(curl -s \
    #       -H "Authorization: Bearer ${GH_TOKEN}" \
    #       -H "Accept: application/vnd.github+json" \
    #       "https://api.github.com/repos/${REPO}/dependabot/alerts")

    #     echo "$ALERTS"

    #     # Ensure API returned array
    #     if ! echo "$ALERTS" | jq -e 'type=="array"' > /dev/null; then
    #       echo "Failed to fetch Dependabot alerts"
    #       exit 1
    #     fi

    #     CRITICAL=$(echo "$ALERTS" | jq '[.[] | select(.security_advisory.severity=="critical")] | length')
    #     HIGH=$(echo "$ALERTS" | jq '[.[] | select(.security_advisory.severity=="high")] | length')

    #     echo "Critical alerts: $CRITICAL"
    #     echo "High alerts: $HIGH"

    #     if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
    #       echo "Security vulnerabilities found!"
    #       exit 1
    #     else
    #       echo "No critical/high vulnerabilities"
    #     fi

    # - name: Update DEPENDABOT_SCAN status
    #   if: always()
    #   uses: azhardevmd/workflows/.github/actions/set-commit-status@main
    #   with:
    #     state: ${{ steps.dependabot_scan.outcome }}
    #     context: DEPENDABOT_SCAN
    #     status_description: "Dependabot Scan ${{ steps.dependabot_scan.outcome }}"
    #     target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

# ---------------- DOCKER BUILD ----------------
    - name: Docker Build
      id: docker_build
      run: |
        docker build -t ${ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${APP_VERSION} .
        docker images

    - name: Update DOCKER_BUILD status
      if: always()
      uses: azhardevmd/workflows/.github/actions/set-commit-status@main
      with:
        state: ${{ steps.docker_build.outcome }}
        context: DOCKER_BUILD
        status_description: "Docker Build ${{ steps.docker_build.outcome }}"
        target_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

# ---------------- PUSH IMAGE ----------------
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v5.1.1
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    
    - name: Puch Images to ECR
      run: |
        aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
        docker push ${ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${APP_VERSION}